<!DOCTYPE html>
<html>
<head>
    <script src="../checkCountry.js"></script>
    <script src="../../header.js"></script>
</head>
<body>
    <div style="position: absolute; top: 10px; right: 10px;" id="userNameDisplay"></div>
    
    <script>
        var authToken = sessionStorage.getItem('token');
        var countryPrefix = localStorage.getItem('urlPrefix');

        if (!authToken) {
            window.location.href = '/B/' + countryPrefix + '/memberLogin.html';
        }

        fetch('/api/checkToken', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + authToken
            }
        }).then(response => response.json())
          .then(data => {
              if (!data.success) {
                  window.location.href = '/B/' + countryPrefix + '/memberLogin.html';
              }
          }).catch(error => console.log(error));

        document.addEventListener('DOMContentLoaded', () => {
            var member = JSON.parse(sessionStorage.getItem('member'));
            document.getElementById('userNameDisplay').innerText = "Hello, " + member.name;

            fetch('/api/getBoughtItem/' + member.id, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            }).then(response => response.json())
              .then(boughtItem => {
                  displaySalesHistory(boughtItem);
              }).catch(error => console.log(error));
        });

        function displaySalesHistory(boughtItem) {
            var salesHistoryTab = document.getElementById("salesHistoryTab");
            if (!boughtItem || boughtItem.length === 0) {
                salesHistoryTab.innerHTML = '<h5 class="center">You do not have any sales history.</h5>';
                return;
            }

            var htmlTxt = '';
            var orderIdList = Array.from(new Set(boughtItem.map(item => item.id))).sort((a, b) => a - b);
            var overallPrice = 0;

            orderIdList.forEach((orderId, index) => {
                var orderItems = boughtItem.filter(item => item.id == orderId);
                var orderTotal = orderItems.reduce((total, item) => total + item.retailPrice * item.quantity, 0);
                overallPrice += orderTotal;

                htmlTxt += `<h5>Order #${index + 1}</h5>`;
                var datePurchased = new Date(orderItems[0].createddate).toLocaleString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                var deliveryDate = addWorkDays(new Date(orderItems[0].createddate), 5);

                htmlTxt += `
                    <h6>Date Purchased: ${datePurchased}</h6>
                    <h6>Estimated Delivery Date: ${deliveryDate}</h6>
                    <h6 style="text-decoration:underline; font-weight:bold">Delivery Details:</h6>
                    <h6>Address: ${orderItems[0].address}</h6>
                    <h6>Postal Code: ${orderItems[0].postalCode}</h6>
                    <h6>Name: ${orderItems[0].customerName}</h6>
                    <h6>Contact Number: ${orderItems[0].phone}</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="row featured-boxes">
                                <div class="col-md-12">
                                    <div class="featured-box featured-box-secundary featured-box-cart">
                                        <div class="box-content">
                                            <table cellspacing="0" class="shop_table cart">
                                                <thead>
                                                    <tr>
                                                        <th class="product-thumbnail">Image</th>
                                                        <th class="product-name">Product</th>
                                                        <th class="product-price">Price</th>
                                                        <th class="product-quantity">Quantity</th>
                                                        <th class="product-subtotal">Subtotal</th>
                                                    </tr>
                                                </thead>
                                                <tbody>`;
                orderItems.forEach(product => {
                    htmlTxt += `
                        <tr class="cart_table_item">
                            <td class="product-thumbnail">
                                <a href="/B/${countryPrefix}/furnitureProductDetails.html?sku=${product.sku}">
                                    <img width="100" height="100" alt="" class="img-responsive" src="${product.imageUrl}">
                                </a>
                            </td>
                            <td class="product-name">
                                <a class="productDetails" href="/B/${countryPrefix}/furnitureProductDetails.html?sku=${product.sku}">${product.itemName}</a>
                            </td>
                            <td class="product-price">
                                $<span class="amount">${product.retailPrice.toFixed(2)}</span>
                            </td>
                            <td class="product-quantity">
                                <span class="qty">${product.quantity}</span>
                            </td>
                            <td class="product-subtotal">
                                $<span class="amount">${(product.retailPrice * product.quantity).toFixed(2)}</span>
                            </td>
                        </tr>`;
                });
                htmlTxt += `
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td class="product-subtotal" style="font-weight: bold; color: #cc3b33">Total:</td>
                                <td class="product-subtotal" style="font-weight: bold">
                                    $<span class="amount">${orderTotal.toFixed(2)}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>`;
            });

            htmlTxt += `<h4 style="font-weight: bold; padding-left: 20px">Total Amount Spent: $${overallPrice.toFixed(2)}</h4>`;
            salesHistoryTab.innerHTML = htmlTxt;
        }

        function addWorkDays(startDate, days) {
            var dow = startDate.getDay();
            var daysToAdd = parseInt(days);
            if (dow == 0) daysToAdd++;
            if (dow + daysToAdd >= 6) {
                var remainingWorkDays = daysToAdd - (5 - dow);
                daysToAdd += 2;
                if (remainingWorkDays > 5) {
                    daysToAdd += 2 * Math.floor(remainingWorkDays / 5);
                    if (remainingWorkDays % 5 == 0) daysToAdd -= 2;
                }
            }
            startDate.setDate(startDate.getDate() + daysToAdd);
            var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return startDate.toLocaleDateString("en-US", options);
        }
    </script>

    <script src="menu2.js"></script>
    <div role="main" class="main">
        <section class="page-top">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <h2>User Profile</h2>
                    </div>
                </div>
            </div>
        </section>
        <div class="container">
            <script src="/displayMessageLong.js"></script>
            <div class="col-md-12">
                <div class="row" style="min-height: 500px;">
                    <div class="tabs">
                        <ul class="nav nav-tabs">
                            <li class="active">
                                <a href="#overview" data-toggle="tab"><i class="icon icon-user"></i> Overview</a>
                            </li>
                            <li>
                                <a href="#loyaltyProgram" data-toggle="tab">Loyalty Program</a>
                            </li>
                            <li>
                                <a href="#salesHistory" data-toggle="tab">Sales History</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div id="overview" class="tab-pane active">
                                <form onsubmit="return submitForm()" id="profileForm">
                                    <h4>Personal Information</h4>
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input class="form-control" required="true" id="name" type="text" />
                                    </div>
                                    <div class="form-group">
                                        <label>E-mail Address</label>
                                        <input class="form-control" required="true" id="email" disabled />
                                    </div>
                                    <div class="form-group">
                                        <label>Phone</label>
                                        <input class="form-control" required="true" pattern="[0-9]*" title="Numbers only" type="text" id="phone" />
                                    </div>
                                    <div class="form-group">
                                        <label>Country</label>
                                        <select id="country">
                                            <!-- Options here -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Address</label>
                                        <input class="form-control" type="text" required="true" id="address" />
                                    </div>
                                    <div class="form-group">
                                        <label>Set Challenge Question</label>
                                        <select id="securityQuestion">
                                            <option value="1">What is your mother's maiden name?</option>
                                            <option value="2">What is your first pet's name?</option>
                                            <option value="3">What is your favourite animal?</option>
                                        </select>
                                        <input class="form-control" type="text" required="true" id="securityAnswer" />
                                    </div>
                                    <div class="form-group">
                                        <label>Age</label>
                                        <input class="form-control" id="age" type="text" required="true" pattern="[0-9]*" title="Numbers only" />
                                    </div>
                                    <div class="form-group">
                                        <label>Income per annum (in USD)</label>
                                        <input class="form-control" id="income" type="text" required="true" pattern="[0-9]*" title="Money without cents" />
                                    </div>
                                    <div class="form-group">
                                        <input style="cursor: pointer" type="checkbox" id="serviceLevelAgreement" value="agreement" />
                                        Allow us to use your particulars to serve you better?
                                        <br />Checking the box above indicates that you agree to our <a onclick="pdpaWindow()" style="cursor: pointer">personal data protection policy.</a>
                                    </div>
                                    <hr class="more-spaced " />
                                    <h4>Change Password</h4>
                                    <div class="form-group">
                                        <label>Old Password (leave blank unless setting a new password).</label>
                                        <input class="form-control" type="password" id="oldPassword">
                                    </div>
                                    <div class="form-group">
                                        <label>New Password<br />Password to be at least 8 characters long.</label>
                                        <input class="form-control" type="password" id="password">
                                    </div>
                                    <div class="form-group">
                                        <label>Re-enter New Password</label>
                                        <input class="form-control" type="password" id="repassword">
                                    </div>
                                    <div class="panel-footer" style="padding-bottom: 0px;">
                                        <div class="row">
                                            <div class="form-group">
                                                <input type="submit" value="Submit" class="btn btn-primary" />
                                                <input type="reset" value="Reset" class="btn btn-primary" />
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div id="loyaltyProgram" class="tab-pane">
                                <h4>Loyalty Program</h4>
                            </div>
                            <div id="salesHistory" class="tab-pane">
                                <h4>Sales History</h4>
                                <div id="salesHistoryTab"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../footer.js"></script>
</body>
</html>
